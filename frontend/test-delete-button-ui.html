<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ é™¤æŒ‰é’®UIæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        .warning { color: #ffc107; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .delete-btn {
            background: #dc3545;
        }
        .delete-btn:hover {
            background: #c82333;
        }
        .activity-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: #fff;
        }
        .activity-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .activity-info {
            color: #666;
            margin: 5px 0;
        }
        .button-group {
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—‘ï¸ åˆ é™¤æŒ‰é’®UIæµ‹è¯•</h1>
        <p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•åˆ é™¤æŒ‰é’®çš„å‰ç«¯äº¤äº’é€»è¾‘</p>
        
        <div class="button-group">
            <button onclick="setupTest()">ğŸš€ è®¾ç½®æµ‹è¯•ç¯å¢ƒ</button>
            <button onclick="testDeleteButton()">ğŸ§ª æµ‹è¯•åˆ é™¤æŒ‰é’®</button>
            <button onclick="clearLogs()">ğŸ§¹ æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <div id="activity-container"></div>
        
        <div class="log" id="log"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        let currentUser = null;
        let currentActivity = null;
        let authToken = null;

        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logElement.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('log').innerHTML = '';
        }

        async function setupTest() {
            try {
                log('ğŸš€ å¼€å§‹è®¾ç½®æµ‹è¯•ç¯å¢ƒ...', 'info');
                
                // 1. ç™»å½•ç”¨æˆ·
                log('1ï¸âƒ£ ç”¨æˆ·ç™»å½•...', 'info');
                const loginResponse = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        password: 'password123'
                    })
                });
                
                const loginData = await loginResponse.json();
                
                if (loginResponse.ok && loginData.user && loginData.token) {
                    currentUser = loginData.user;
                    authToken = loginData.token;
                    log(`âœ… ç™»å½•æˆåŠŸ: ${currentUser.username}`, 'success');
                } else {
                    throw new Error('ç™»å½•å¤±è´¥: ' + JSON.stringify(loginData));
                }
                
                // 2. åˆ›å»ºæµ‹è¯•æ´»åŠ¨
                log('2ï¸âƒ£ åˆ›å»ºæµ‹è¯•æ´»åŠ¨...', 'info');
                const activityData = {
                    title: 'ğŸ—‘ï¸ UIåˆ é™¤æµ‹è¯•æ´»åŠ¨',
                    description: 'è¿™æ˜¯ä¸€ä¸ªç”¨äºæµ‹è¯•å‰ç«¯åˆ é™¤æŒ‰é’®çš„æ´»åŠ¨',
                    category: 'ç¯®çƒ',
                    location: 'æµ‹è¯•ä½“è‚²é¦†',
                    startTime: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                    endTime: new Date(Date.now() + 25 * 60 * 60 * 1000).toISOString(),
                    registrationDeadline: new Date(Date.now() + 12 * 60 * 60 * 1000).toISOString(),
                    maxParticipants: 10,
                    price: 0
                };
                
                const createResponse = await fetch(`${API_BASE}/activities`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(activityData)
                });
                
                const createData = await createResponse.json();
                
                if (createResponse.ok && createData.success) {
                    currentActivity = createData.data.activity;
                    log(`âœ… æ´»åŠ¨åˆ›å»ºæˆåŠŸ: ${currentActivity.title}`, 'success');
                    log(`   æ´»åŠ¨ID: ${currentActivity.id}`, 'info');
                    
                    // æ˜¾ç¤ºæ´»åŠ¨å¡ç‰‡
                    displayActivityCard();
                } else {
                    throw new Error('æ´»åŠ¨åˆ›å»ºå¤±è´¥: ' + JSON.stringify(createData));
                }
                
                log('ğŸ‰ æµ‹è¯•ç¯å¢ƒè®¾ç½®å®Œæˆï¼', 'success');
                
            } catch (error) {
                log(`âŒ è®¾ç½®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function displayActivityCard() {
            if (!currentActivity) return;
            
            const container = document.getElementById('activity-container');
            container.innerHTML = `
                <div class="activity-card">
                    <div class="activity-title">${currentActivity.title}</div>
                    <div class="activity-info">ğŸ“ åœ°ç‚¹: ${currentActivity.location}</div>
                    <div class="activity-info">ğŸ‘¥ æœ€å¤§äººæ•°: ${currentActivity.maxParticipants}</div>
                    <div class="activity-info">ğŸ’° ä»·æ ¼: ${currentActivity.price === 0 ? 'å…è´¹' : 'Â¥' + currentActivity.price}</div>
                    <div class="activity-info">â° å¼€å§‹æ—¶é—´: ${new Date(currentActivity.startTime).toLocaleString()}</div>
                    <div class="activity-info">ğŸ‘¤ åˆ›å»ºè€…: ${currentUser?.username}</div>
                    
                    <div class="button-group">
                        <button class="delete-btn" onclick="handleDeleteActivity()">
                            ğŸ—‘ï¸ åˆ é™¤æ´»åŠ¨
                        </button>
                    </div>
                </div>
            `;
        }

        async function handleDeleteActivity() {
            if (!currentActivity) {
                log('âŒ æ²¡æœ‰æ´»åŠ¨å¯åˆ é™¤', 'error');
                return;
            }
            
            log('ğŸ—‘ï¸ ç”¨æˆ·ç‚¹å‡»åˆ é™¤æŒ‰é’®', 'info');
            
            // æ¨¡æ‹Ÿç¡®è®¤å¼¹çª—
            const confirmed = confirm(`æ‚¨ç¡®å®šè¦åˆ é™¤æ´»åŠ¨ã€Œ${currentActivity.title}ã€å—ï¼Ÿ\n\nâš ï¸ æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œåˆ é™¤åæ‰€æœ‰ç›¸å…³æ•°æ®å°†æ°¸ä¹…ä¸¢å¤±ï¼`);
            
            if (!confirmed) {
                log('âŒ ç”¨æˆ·å–æ¶ˆåˆ é™¤æ“ä½œ', 'warning');
                return;
            }
            
            log('âœ… ç”¨æˆ·ç¡®è®¤åˆ é™¤ï¼Œå¼€å§‹æ‰§è¡Œåˆ é™¤...', 'info');
            
            try {
                const deleteResponse = await fetch(`${API_BASE}/activities/${currentActivity.id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const deleteData = await deleteResponse.json();
                
                if (deleteResponse.ok && deleteData.success) {
                    log('âœ… åˆ é™¤æˆåŠŸï¼', 'success');
                    log('ğŸ”„ æ¨¡æ‹Ÿè·³è½¬åˆ°æ´»åŠ¨åˆ—è¡¨é¡µé¢...', 'info');
                    
                    // æ¸…ç©ºæ´»åŠ¨å¡ç‰‡
                    document.getElementById('activity-container').innerHTML = '<p style="color: #28a745; text-align: center; padding: 20px;">âœ… æ´»åŠ¨å·²åˆ é™¤ï¼Œå·²è·³è½¬åˆ°æ´»åŠ¨åˆ—è¡¨é¡µé¢</p>';
                    
                    // éªŒè¯åˆ é™¤ç»“æœ
                    await verifyDeletion();
                    
                } else {
                    throw new Error(deleteData.message || 'åˆ é™¤å¤±è´¥');
                }
                
            } catch (error) {
                log(`âŒ åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function verifyDeletion() {
            try {
                log('ğŸ” éªŒè¯åˆ é™¤ç»“æœ...', 'info');
                
                // å°è¯•è·å–å·²åˆ é™¤çš„æ´»åŠ¨
                const response = await fetch(`${API_BASE}/activities/${currentActivity.id}`);
                
                if (response.status === 404) {
                    log('âœ… éªŒè¯æˆåŠŸï¼šæ´»åŠ¨å·²ä»æ•°æ®åº“ä¸­åˆ é™¤', 'success');
                } else {
                    log('âŒ éªŒè¯å¤±è´¥ï¼šæ´»åŠ¨ä»ç„¶å­˜åœ¨', 'error');
                }
                
                // æ£€æŸ¥æ´»åŠ¨åˆ—è¡¨
                const listResponse = await fetch(`${API_BASE}/activities`);
                const listData = await listResponse.json();
                const activities = listData.data?.activities || [];
                
                const foundInList = activities.find(a => a.id === currentActivity.id);
                if (!foundInList) {
                    log('âœ… éªŒè¯æˆåŠŸï¼šæ´»åŠ¨å·²ä»åˆ—è¡¨ä¸­ç§»é™¤', 'success');
                } else {
                    log('âŒ éªŒè¯å¤±è´¥ï¼šæ´»åŠ¨ä»åœ¨åˆ—è¡¨ä¸­', 'error');
                }
                
                currentActivity = null;
                
            } catch (error) {
                log(`âŒ éªŒè¯è¿‡ç¨‹å‡ºé”™: ${error.message}`, 'error');
            }
        }

        async function testDeleteButton() {
            log('ğŸ§ª å¼€å§‹æµ‹è¯•åˆ é™¤æŒ‰é’®åŠŸèƒ½...', 'info');
            
            if (!currentActivity) {
                log('âŒ è¯·å…ˆè®¾ç½®æµ‹è¯•ç¯å¢ƒ', 'error');
                return;
            }
            
            log('ğŸ“‹ åˆ é™¤æŒ‰é’®æµ‹è¯•æ¸…å•:', 'info');
            log('  âœ… åˆ é™¤æŒ‰é’®å·²æ˜¾ç¤º', 'success');
            log('  âœ… ç‚¹å‡»æŒ‰é’®ä¼šæ˜¾ç¤ºç¡®è®¤å¼¹çª—', 'success');
            log('  âœ… ç¡®è®¤åè°ƒç”¨åˆ é™¤API', 'success');
            log('  âœ… åˆ é™¤æˆåŠŸåæ¨¡æ‹Ÿé¡µé¢è·³è½¬', 'success');
            log('  âœ… éªŒè¯æ•°æ®åº“ä¸­æ•°æ®å·²åˆ é™¤', 'success');
            log('\nğŸ’¡ è¯·ç‚¹å‡»ä¸Šæ–¹çš„"ğŸ—‘ï¸ åˆ é™¤æ´»åŠ¨"æŒ‰é’®è¿›è¡Œå®é™…æµ‹è¯•', 'info');
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.onload = function() {
            log('ğŸŒŸ åˆ é™¤æŒ‰é’®UIæµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
            log('ğŸ“ ä½¿ç”¨è¯´æ˜:', 'info');
            log('  1. ç‚¹å‡»"ğŸš€ è®¾ç½®æµ‹è¯•ç¯å¢ƒ"åˆ›å»ºæµ‹è¯•æ´»åŠ¨', 'info');
            log('  2. ç‚¹å‡»æ´»åŠ¨å¡ç‰‡ä¸­çš„"ğŸ—‘ï¸ åˆ é™¤æ´»åŠ¨"æŒ‰é’®', 'info');
            log('  3. åœ¨ç¡®è®¤å¼¹çª—ä¸­é€‰æ‹©ç¡®è®¤æˆ–å–æ¶ˆ', 'info');
            log('  4. è§‚å¯Ÿåˆ é™¤è¿‡ç¨‹å’Œç»“æœéªŒè¯', 'info');
        };
    </script>
</body>
</html>